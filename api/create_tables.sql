BEGIN;

DROP TABLE IF EXISTS "user", "account", "detail_account", "budget", "detail_budget", "tag";

CREATE TABLE "user" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "pseudo" VARCHAR(255) NOT NULL UNIQUE,
  "email" VARCHAR(255) NOT NULL UNIQUE,
  "password" TEXT NOT NULL,
  "role" VARCHAR(255) NOT NULL DEFAULT USER,
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMPTZ
);


CREATE TABLE "account" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "title" VARCHAR(255) NOT NULL,
  "user_id" INTEGER NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMPTZ
);

CREATE TABLE "budget" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "title" VARCHAR(255) NOT NULL,
  "user_id" INTEGER NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
  "limit" DECIMAL(10, 2),
  "date" CHAR(7) NOT NULL, --YYYY-MM
  "account_id" INTEGER NOT NULL REFERENCES "account"("id") ON DELETE CASCADE,
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMPTZ
);

CREATE TABLE "detail_account" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "date" CHAR(10) NOT NULL, --YYYY-MM-DD
  "amount" DECIMAL(10, 2) NOT NULL,
  "title" VARCHAR(255),
  "type" VARCHAR(255),
  "account_id" INTEGER NOT NULL REFERENCES "account"("id") ON DELETE CASCADE,
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMPTZ
);

CREATE TABLE "detail_budget" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "amount" DECIMAL(10, 2) NOT NULL,
  "title" VARCHAR(255),
  "date" CHAR(7) NOT NULL, --YYYY-MM
  "budget_id" INTEGER NOT NULL REFERENCES "budget"("id") ON DELETE CASCADE,
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMPTZ
);

CREATE TABLE "tag" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "title" VARCHAR(255),
  "detail_account_id" INTEGER REFERENCES "detail_account"("id") ON DELETE CASCADE,
  "detail_budget_id" INTEGER REFERENCES "detail_budget"("id") ON DELETE CASCADE,
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMPTZ
   CONSTRAINT check_account_or_budget
   CHECK (
      ("detail_account_id" IS NOT NULL AND "detail_budget_id" IS NULL) OR
      ("detail_account_id" IS NULL AND "detail_budget_id" IS NOT NULL)
   )
);

COMMIT;

